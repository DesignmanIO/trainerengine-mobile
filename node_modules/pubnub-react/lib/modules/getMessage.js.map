{"version":3,"sources":["modules/getMessage.js"],"names":["getMessage","init","component","channel","state","pn_messages","setState","prevState","$merge","emit","instance","message","messages","_component","keepMessages","_keepMessages","push","length","slice","$set","_broadcast","callback","arguments","_autoload","getHistory","_listener","subscription","isSubscribe"],"mappings":"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","file":"getMessage.js","sourcesContent":["import update from 'immutability-helper';\n\n/**\n * Add a channel to the state pn_messages\n *\n * @param {PubNubReact} instance\n * @param {string} channel\n * @returns {boolean}\n */\nfunction init(component, channel) {\n  if (component.state.pn_messages[channel]) {\n    return false;\n  } else {\n    component.setState(prevState => ({\n      pn_messages: update(prevState.pn_messages, { $merge: { [channel]: [] } })\n    }));\n\n    return true;\n  }\n}\n\n/**\n * Emit a message through a callback and update the state\n *\n * @param {PubNubReact} instance\n * @param {string} channel\n * @param {object} message\n */\nfunction emit(instance, channel, message) {\n  let messages = instance._component.state.pn_messages[channel];\n  let keepMessages = instance._keepMessages[channel];\n\n  messages.push(message);\n\n  if (keepMessages && messages.length > keepMessages) {\n    messages = messages.slice(messages.length - keepMessages);\n  }\n\n  instance._component.setState(prevState => ({\n    pn_messages: update(prevState.pn_messages, { [channel]: { $set: messages } })\n  }));\n\n  instance._broadcast.emit('message', channel, message);\n}\n\n/**\n * Get to receive messages from a channel through a callback\n *\n * @param {string} channel\n * @param {function} callback\n * @returns {[]}\n */\nexport function getMessage(channel) {\n  let component = this._component;\n  let callback;\n  let keepMessages = 100;\n\n  if (arguments.length === 2 && typeof arguments[1] === 'function') {\n    callback = arguments[1];\n  } else if (arguments.length === 2 && typeof arguments[1] === 'number') {\n    keepMessages = arguments[1];\n  } else if (arguments.length === 3) {\n    callback = arguments[1];\n    keepMessages = arguments[2];\n  }\n\n  if (init(component, channel)) {\n    this._keepMessages[channel] = keepMessages;\n    this._autoload.getHistory(channel, callback);\n  }\n\n  this._broadcast.message(channel, callback);\n\n  if (!this._listener.message) {\n    this._listener.message = (message) => {\n      if (message.subscription && this._broadcast.isSubscribe('message', message.subscription)) {\n        emit(this, message.subscription, message);\n      }\n\n      if (message.channel && this._broadcast.isSubscribe('message', message.channel)) {\n        emit(this, message.channel, message);\n      }\n    };\n  }\n\n  if (component.state && component.state.pn_messages && component.state.pn_messages[channel]) {\n    return component.state.pn_messages[channel];\n  } else {\n    return [];\n  }\n}\n"]}